<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>나의 퀘스트</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f8f9fc;
            margin: 0;
            color: #222;
        }
        header {
            background: linear-gradient(135deg, #02071e, #030928);
            color: white;
            padding: 30px 0;
            text-align: center;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }
        .stats {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 10px;
            font-size: 0.95em;
            color: #ddd;
        }
        .home-btn {
            display: inline-block;
            margin-top: 15px;
            color: #fff;
            text-decoration: none;
            font-weight: bold;
            font-size: 0.9em;
        }
        .ai-feedback {
            background: #fff9e6;
            border-left: 5px solid #ffd43b;
            color: #555;
            margin: 25px auto;
            max-width: 700px;
            padding: 15px;
            border-radius: 8px;
            font-style: italic;
            text-align: center;
        }
        .content {
            max-width: 800px;
            margin: 30px auto;
            padding: 0 20px;
        }
        h2 {
            border-left: 6px solid #030928;
            padding-left: 10px;
            color: #030928;
            margin-top: 40px;
        }
        .quest-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            margin: 15px 0;
            display: flex;
            align-items: center;
            padding: 15px;
            transition: transform 0.2s;
        }
        .quest-card:hover { transform: translateY(-3px); cursor: pointer; }
        .quest-card.active { border-left: 5px solid #007bff; }
        .quest-card.completed { border-left: 5px solid #28a745; background: #f7fdf8; }
        .emoji { font-size: 2em; width: 50px; text-align: center; }
        .info h3 { margin: 0; color: #111; font-size: 1.1em; }
        .progress-bar {
            width: 100%; background: #eee; border-radius: 6px;
            height: 8px; margin-top: 8px; overflow: hidden;
        }
        .progress-fill {
            height: 100%; background: #007bff; width: 0%;
            transition: width 0.3s ease-in-out;
        }
        .status.active { color: #007bff; font-weight: bold; }
        .status.completed { color: #28a745; }
        button {
            background: #02071e; color: white; border: none;
            border-radius: 6px; padding: 7px 10px; font-size: 0.85em;
            cursor: pointer; margin-left: 5px;
        }
        .delete-btn { background: #dc3545; }
        .no-quest { text-align: center; color: #777; font-style: italic; }

        /* 추가 폼 */
        .add-form {
            background: white;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            padding: 25px;
            margin-top: 40px;
        }
        .add-form input, .add-form select, .add-form textarea {
            width: 100%;
            margin: 8px 0;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
        }
        .add-form button {
            background: #030928;
            color: white;
            border: none;
            width: 100%;
            padding: 12px;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            margin-top: 10px;
        }

        /* 진행률 모달 */
        .modal {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000;
        }
        .modal.hidden { display: none; }
        .modal-content {
            background: white; padding: 20px; border-radius: 10px;
            width: 320px; text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        #progress-grid {
            display: grid; grid-template-columns: repeat(auto-fill, 30px);
            gap: 5px; justify-content: center; margin-top: 15px;
        }
        .progress-cell {
            width: 30px; height: 30px; background: #eee;
            border-radius: 5px; cursor: pointer;
        }
        .progress-cell.checked { background: #007bff; }
    </style>
</head>
<body>
    <header>
        <h1>{{ user.name }}님의 퀘스트 보드</h1>
        <div class="stats">
            <span>총 퀘스트: {{ total }}</span>
            <span>완료: {{ completed }}</span>
            <span>달성률: {{ "%.1f" % completion_rate }}%</span>
        </div>
        <a href="/" class="home-btn">홈으로</a>
    </header>

    <div class="ai-feedback">{{ ai_message }}</div>

    <div class="content">
        <h2>진행 중</h2>
        {{ active_html|safe }}

        <h2 onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'" 
            style="cursor: pointer; user-select: none;">
            완료된 퀘스트 ({{ completed }}) <span style="font-size:0.8em;">▼</span>
        </h2>
        <div style="display: none;">
            {{ completed_html | safe }}
        </div>

        <div class="add-form">
            <h2>새로운 퀘스트 추가</h2>
            <form id="quest-form">
                <input type="hidden" name="user_id" value="{{ user.id }}">
                <input type="text" name="name" placeholder="예: 매일 30분 운동하기" required>
                <select name="category">
                    <option value="exercise">운동</option>
                    <option value="study">공부</option>
                    <option value="reading">독서</option>
                    <option value="work">일</option>
                    <option value="hobby">취미</option>
                    <option value="health">건강</option>
                    <option value="general">일반</option>
                </select>
                <input type="number" name="duration" placeholder="기간 (일)" min="1">
                <input type="number" name="difficulty" placeholder="난이도 (1~5)" min="1" max="5">
                <textarea name="motivation" placeholder="동기 부여 문구 (선택)"></textarea>
                <button type="submit">AI 성공률 예측 및 추가</button>
            </form>
        </div>
    </div>

    <div id="progress-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="modal-quest-name"></h3>
            <div id="progress-grid"></div>
            <button id="close-modal">닫기</button>
        </div>
    </div>

    <script>
        document.getElementById('quest-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target).entries());
            data.user_id = parseInt(data.user_id);
            data.duration = data.duration ? parseInt(data.duration) : 1;
            data.difficulty = data.difficulty ? parseInt(data.difficulty) : null;
            const res = await fetch("/quests/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data),
                credentials: "include"
            });
            if (res.ok) location.reload();
            else alert("퀘스트 추가 실패");
        });

        const modal = document.getElementById("progress-modal");
        const grid = document.getElementById("progress-grid");
        const modalName = document.getElementById("modal-quest-name");
        const closeModal = document.getElementById("close-modal");

        document.querySelectorAll('.quest-card.active').forEach(card => {
    card.addEventListener('click', (e) => {
        if (e.target.classList.contains('toggle-btn') || e.target.classList.contains('delete-btn')) return;

        const questId = card.dataset.questId;
        const duration = parseInt(card.dataset.duration) || 1;
        let progress = parseFloat(card.dataset.progress) || 0;

        modalName.innerText = card.querySelector('h3').innerText + " 진행 관리";

        // 기존 이벤트 제거!
        grid.querySelectorAll('.progress-cell').forEach(cell => {
                cell.replaceWith(cell.cloneNode(true));
            });
            grid.innerHTML = '';

            const checkedCells = Math.round((progress / 100) * duration);

            for (let i = 1; i <= duration; i++) {
                const cell = document.createElement('div');
                cell.classList.add('progress-cell');
                if (i <= checkedCells) cell.classList.add('checked');

                cell.addEventListener('click', async () => {
                    cell.classList.toggle('checked');
                    const done = grid.querySelectorAll('.checked').length;
                    const newProgress = parseFloat(((done / duration) * 100).toFixed(1));

                    const res = await fetch(`/quests/${questId}/progress`, {
                        method: "PATCH",
                        headers: { "Content-Type": "application/json" },
                        credentials: "include",
                        body: JSON.stringify({ progress: newProgress })
                    });

                    if (res.ok) {
                        progress = newProgress;  // 최신값 유지
                        card.querySelector('.progress-fill').style.width = newProgress + "%";
                        card.dataset.progress = newProgress;
                        card.querySelector('.status').innerText = 
                            "진행 중 (" + newProgress.toFixed(1) + "%)";
                    } else {
                        alert("업데이트 실패");
                    }
                });

                    grid.appendChild(cell);
                }
                modal.classList.remove('hidden');
            });
        });

        closeModal.addEventListener('click', () => modal.classList.add('hidden'));

        document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const id = e.target.dataset.itemId;
            if (!id || id === '0') return alert("퀘스트 ID 오류");

            await fetch(`/quests/${id}/toggle`, {
                method: "PATCH",
                credentials: "include"
            });
                location.reload();
            });
        });

        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.stopPropagation();
                if (!confirm("정말 삭제하시겠습니까?")) return;
                const id = e.target.dataset.itemId;
                if (!id || id === '0') return alert("퀘스트 ID 오류");

                await fetch(`/quests/${id}`, {
                    method: "DELETE",
                    credentials: "include"
                });
                location.reload();
            });
        });

        // 진행률 업데이트도 수정
        cell.addEventListener('click', async () => {
            cell.classList.toggle('checked');
            const done = grid.querySelectorAll('.checked').length;
            const newProgress = parseFloat(((done / duration) * 100).toFixed(1));

            const questId = card.dataset.questId;
            if (!questId || questId === '0') return;

            const res = await fetch(`/quests/${questId}/progress`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json" },
                credentials: "include",
                body: JSON.stringify({ progress: newProgress })
            });

            if (res.ok) {
                card.querySelector('.progress-fill').style.width = newProgress + "%";
                card.dataset.progress = newProgress;
                card.querySelector('.status').innerText = `진행 중 (` + newProgress + `%)`;
            } else {
                alert("진행률 업데이트 실패");
            }
        });
    </script>
</body>
</html>