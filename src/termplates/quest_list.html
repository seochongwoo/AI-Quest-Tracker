<!DOCTYPE html>
<html>
    <head>
        <title>ë‚˜ì˜ í€˜ìŠ¤íŠ¸</title>
        <style>
            body {
                font-family: 'Segoe UI', sans-serif;
                background: #f8f9fc;
                margin: 0;
                color: #222;
            }
            header {
                background: linear-gradient(135deg, #02071e, #030928);
                color: white;
                padding: 30px 0;
                text-align: center;
                box-shadow: 0 3px 6px rgba(0,0,0,0.15);
            }
            .stats {
                display: flex;
                justify-content: center;
                gap: 25px;
                margin-top: 10px;
                font-size: 0.95em;
                color: #ddd;
            }
            .ai-feedback {
                background: #fff9e6;
                border-left: 5px solid #ffd43b;
                color: #555;
                margin: 25px auto;
                max-width: 700px;
                padding: 15px;
                border-radius: 8px;
                font-style: italic;
                text-align: center;
            }
            .content {
                max-width: 800px;
                margin: 30px auto;
                padding: 0 20px;
            }
            h2 {
                border-left: 6px solid #030928;
                padding-left: 10px;
                color: #030928;
                margin-top: 40px;
            }
            .quest-card {
                background: white;
                border-radius: 10px;
                box-shadow: 0 2px 6px rgba(0,0,0,0.08);
                margin: 15px 0;
                display: flex;
                align-items: center;
                padding: 15px;
                transition: transform 0.2s;
            }
            .quest-card:hover {transform: translateY(-3px); cursor: pointer; }
            .quest-card.active { border-left: 5px solid #007bff; }
            .quest-card.completed { border-left: 5px solid #28a745; background: #f7fdf8; }
            .emoji { font-size: 2em; width: 50px; text-align: center; }
            .info h3 { margin: 0; color: #111; font-size: 1.1em; }
            .progress-bar {
                width: 100%; background: #eee; border-radius: 6px;
                height: 8px; margin-top: 8px; overflow: hidden;
            }
            .progress-fill {
                height: 100%; background: #007bff; width: 0%;
                transition: width 0.3s ease-in-out;
            }
            .status.active { color: #007bff; font-weight: bold; }
            .status.completed { color: #28a745; }
            button {
                background: #02071e; color: white; border: none;
                border-radius: 6px; padding: 7px 10px; font-size: 0.85em;
                cursor: pointer; margin-left: 5px;
            }
            .delete-btn { background: #dc3545; }
            .no-quest { text-align: center; color: #777; font-style: italic; }

            /* ì¶”ê°€ í¼ */
            .add-form {
                background: white;
                border-radius: 12px;
                box-shadow: 0 3px 10px rgba(0,0,0,0.1);
                padding: 25px;
                margin-top: 40px;
            }
            .add-form input, .add-form select, .add-form textarea {
                width: 100%;
                margin: 8px 0;
                padding: 10px;
                border: 1px solid #ccc;
                border-radius: 6px;
            }
            .add-form button {
                background: #030928;
                color: white;
                border: none;
                width: 100%;
                padding: 12px;
                border-radius: 6px;
                font-size: 1em;
                cursor: pointer;
            }

            /* ì§„í–‰ë¥  ëª¨ë‹¬ */
            .modal {
                position: fixed; top: 0; left: 0;
                width: 100%; height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex; justify-content: center; align-items: center;
            }
            .modal.hidden { display: none; }
            .modal-content {
                background: white; padding: 20px; border-radius: 10px;
                width: 320px; text-align: center;
            }
            #progress-grid {
                display: grid; grid-template-columns: repeat(auto-fill, 30px);
                gap: 5px; justify-content: center; margin-top: 15px;
            }
            .progress-cell {
                width: 30px; height: 30px; background: #eee;
                border-radius: 5px; cursor: pointer;
            }
            .progress-cell.checked { background: #007bff; }
        </style>
    </head>
    <body>
        <header>
            <h1>{user.name}ë‹˜ì˜ í€˜ìŠ¤íŠ¸ ë³´ë“œ</h1>
            <div class="stats">
                <span>ì´ í€˜ìŠ¤íŠ¸: {total}</span>
                <span>ì™„ë£Œ: {completed}</span>
                <span>ë‹¬ì„±ë¥ : {completion_rate:.1f}%</span>
            </div>
            <a href="/" class="home-btn">ğŸ  í™ˆìœ¼ë¡œ</a>
        </header>

        <div class="ai-feedback">{ai_message}</div>
        <div class="content">
            <h2>ğŸŸ¢ ì§„í–‰ ì¤‘</h2>{active_html}
            <h2>ğŸ ì™„ë£Œëœ í€˜ìŠ¤íŠ¸</h2>
            <p><a href="/quests/completed" class="link">ì—¬ê¸°ë¡œ ì´ë™ â†’</a></p>

            <div class="add-form">
                <h2>â• ìƒˆë¡œìš´ í€˜ìŠ¤íŠ¸ ì¶”ê°€</h2>
                <form id="quest-form">
                    <input type="hidden" name="user_id" value="{user_id_int}">
                    <input type="text" name="name" placeholder="ì˜ˆ: ë§¤ì¼ 30ë¶„ ìš´ë™í•˜ê¸°" required>
                    <select name="category">
                        <option value="exercise">ìš´ë™</option>
                        <option value="study">ê³µë¶€</option>
                        <option value="reading">ë…ì„œ</option>
                        <option value="work">ì¼</option>
                        <option value="hobby">ì·¨ë¯¸</option>
                        <option value="health">ê±´ê°•</option>
                        <option value="general">ì¼ë°˜</option>
                    </select>
                    <input type="number" name="duration" placeholder="ê¸°ê°„ (ì¼)" min="1">
                    <input type="number" name="difficulty" placeholder="ë‚œì´ë„ (1~5)" min="1" max="5">
                    <textarea name="motivation" placeholder="ë™ê¸° ë¶€ì—¬ ë¬¸êµ¬ (ì„ íƒ)"></textarea>
                    <button type="submit">AI ì„±ê³µë¥  ì˜ˆì¸¡ ë° ì¶”ê°€</button>
                </form>
            </div>
        </div>

        <div id="progress-modal" class="modal hidden">
            <div class="modal-content">
                <h3 id="modal-quest-name"></h3>
                <div id="progress-grid"></div>
                <button id="close-modal">ë‹«ê¸°</button>
            </div>
        </div>

        <script>
        // í€˜ìŠ¤íŠ¸ ì¶”ê°€
        document.getElementById('quest-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(e.target).entries());
            data.user_id = parseInt(data.user_id);
            data.duration = data.duration ? parseInt(data.duration) : 1;
            data.difficulty = data.difficulty ? parseInt(data.difficulty) : null;
            const res = await fetch("/quests/", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data),
                credentials: "include"
            });
            if (res.ok) location.reload();
            else alert("í€˜ìŠ¤íŠ¸ ì¶”ê°€ ì‹¤íŒ¨");
        });

        // ì§„í–‰ë¥  ëª¨ë‹¬
        const modal = document.getElementById("progress-modal");
        const grid = document.getElementById("progress-grid");
        const modalName = document.getElementById("modal-quest-name");
        const closeModal = document.getElementById("close-modal");

        document.querySelectorAll('.quest-card.active').forEach(card => {{
            card.addEventListener('click', (e) => {{
                if (e.target.classList.contains('toggle-btn') || e.target.classList.contains('delete-btn')) return;

                const questId = card.dataset.questId;
                const duration = parseInt(card.dataset.duration);
                const progress = parseFloat(card.dataset.progress);
                modalName.innerText = card.querySelector('h3').innerText + " ì§„í–‰ ê´€ë¦¬";

                grid.innerHTML = '';
                const checkedCells = Math.round((progress / 100) * duration);

                for (let i = 1; i <= duration; i++) {{
                    const cell = document.createElement('div');
                    cell.classList.add('progress-cell');
                    if (i <= checkedCells) cell.classList.add('checked');

                    cell.addEventListener('click', async () => {
                        cell.classList.toggle('checked');
                        const done = grid.querySelectorAll('.checked').length;
                        const newProgress = parseFloat(((done / duration) * 100).toFixed(1));
                        console.log("duration:", duration, "done:", done, "newProgress:", newProgress)

                        const res = await fetch(`/quests/${{questId}}/progress`, {
                            method: "PATCH",
                            headers: { "Content-Type": "application/json" },
                            credentials: "include",
                            body: JSON.stringify({ progress: newProgress })
                        });

                        if (res.ok) {{
                            card.querySelector('.progress-fill').style.width = newProgress + "%";
                            card.dataset.progress = newProgress;
                            card.querySelector('.status').innerText = `ğŸ•“ ì§„í–‰ ì¤‘ (${{newProgress}}%)`;
                        }} else {{
                            alert("ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ ì‹¤íŒ¨");
                        }}
                    });

                    grid.appendChild(cell);
                }}
                modal.classList.remove('hidden');
            }});
        }});
        closeModal.addEventListener('click', () => modal.classList.add('hidden'));

        // ì™„ë£Œ í† ê¸€
        document.querySelectorAll('.toggle-btn').forEach(btn => {
            btn.addEventListener('click', async e => {
                e.stopPropagation();
                const id = e.target.dataset.itemId;
                await fetch(`/quests/${{id}}/toggle`, { method: "PATCH", credentials: "include" });
                location.reload();
            });
        });

        // ì‚­ì œ
        document.querySelectorAll('.delete-btn').forEach(btn => {{
            btn.addEventListener('click', async e => {
                e.stopPropagation();
                if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                const id = e.target.dataset.itemId;
                await fetch(`/quests/${{id}}`, { method: "DELETE", credentials: "include" });
                location.reload();
            });
        }});
        </script>
    </body>
    </html>